# A continuación se muestra un ejemplo de cómo configurar un PDF en un proyecto ASP.NET.

# Generalidades:
- Versión del framework: .NET 9.0 (Soporte técnico de términos estándar).
- Base de datos: SSQL (SSMS/SQL SERVER MANAGEMENT STUDIO) 2022.

## 1. Frameworks instalados:

```
MicrosoftEntityFrameworkCore (9.0.8)
```
```
MicrosoftEntityFrameworkCore.SqlServer (9.0.8)
```
```
MicrosoftEntityFrameworkCore.Tools (9.0.8)
```
```
QuestPDF (2025.7.0)
```

## 2. Crear Base de Datos en SSQL:

### 2.1. Creando Base de Datos: (EL NOMBRE DE LA BASE DE DATOS PUEDE SER OTRO)

```
CREATE DATABASE practicaSSM
```

### 2.2. Creando Tablas:

Para este proyecto se hará uso de 3 tablas.

```
CREATE TABLE productos (
    id INT IDENTITY(1,1) PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT NOT NULL,
    precio DECIMAL(10,2) NOT NULL,
    stock INT NOT NULL,
    fecha_creacion DATE NOT NULL
);

CREATE TABLE ventas (
    id INT IDENTITY(1,1) PRIMARY KEY,
    fecha DATE NOT NULL,
    total DECIMAL(10,2) NOT NULL
);

CREATE TABLE detalles_ventas (
    id INT IDENTITY(1,1) PRIMARY KEY,
    venta_id INT NOT NULL,
    producto_id INT NOT NULL,
    cantidad INT NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (venta_id) REFERENCES ventas(id),
    FOREIGN KEY (producto_id) REFERENCES productos(id)
);
```

### 2.4. Insertando datos a las tablas:

Tabla de productos

```
INSERT INTO productos (nombre, descripcion, precio, stock, fecha_creacion) VALUES
('Laptop Lenovo ThinkPad', 'Laptop empresarial con procesador Intel i5, 8GB RAM y 256GB SSD.', 950.00, 15, '2025-08-01');

INSERT INTO productos (nombre, descripcion, precio, stock, fecha_creacion) VALUES
('Mouse Logitech M185', 'Mouse inalámbrico compacto, ideal para uso diario.', 18.99, 50, '2025-08-02');

INSERT INTO productos (nombre, descripcion, precio, stock, fecha_creacion) VALUES
('Monitor Samsung 24"', 'Monitor LED Full HD de 24 pulgadas.', 179.50, 20, '2025-08-03');

INSERT INTO productos (nombre, descripcion, precio, stock, fecha_creacion) VALUES
('Teclado Mecánico Redragon', 'Teclado mecánico retroiluminado para gamers.', 45.75, 30, '2025-08-04');

INSERT INTO productos (nombre, descripcion, precio, stock, fecha_creacion) VALUES
('Silla Ergonomica', 'Silla de oficina ergonómica con soporte lumbar.', 120.00, 10, '2025-08-05');
```

### 2.5. Insertando datos a la tabla clientes:

Tabla de ventas:

```
INSERT INTO ventas (fecha, total) VALUES ('2025-08-10', 350.99);
INSERT INTO ventas (fecha, total) VALUES ('2025-08-11', 126.50);
INSERT INTO ventas (fecha, total) VALUES ('2025-08-12', 785.25);
INSERT INTO ventas (fecha, total) VALUES ('2025-08-13', 240.00);
INSERT INTO ventas (fecha, total) VALUES ('2025-08-13', 90.75);
```

### 2.6. Insertando datos a la tabla detalles_ventas:

Tabla de detalles_ventas:

```
INSERT INTO detalles_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal) VALUES
(1, 1, 1, 950.00, 950.00);

INSERT INTO detalles_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal) VALUES
(1, 2, 2, 18.99, 37.98);

INSERT INTO detalles_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal) VALUES
(2, 3, 1, 179.50, 179.50);

INSERT INTO detalles_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal) VALUES
(3, 4, 3, 45.75, 137.25);

INSERT INTO detalles_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal) VALUES
(4, 5, 2, 120.00, 240.00);
```

## 3. Habiendo creado el proyecto de ASP.NET previamente, se debe configurar el archivo "Program.cs":

### 3.1. Agregar la licencia de QuestPDF:

Esta es la importación:

```
using QuestPDF.Infrastructure;
```

**Este línea de código es para aplicar la licencia. De esta manera se utiliza de forma global:**

Agregarlo arriba de **builder.Services.AddControllersWithViews();**

```
QuestPDF.Settings.License = LicenseType.Community;
```

## 4. En el archivo appsettins.json, se debe agregar la cadena de conexión hacia la base de datos:

Esta cadena de conexión está utilizando el servidor de mi computadora, por ello se debe cambiar el servidor y el nombre de la base de datos.

```
"ConnectionStrings": {
  "DefaultConnection": "Server=CARLOS-AR;Database=practicaSSM;Trusted_Connection=True; Trust Server Certificate=true;"
}
```

## 5. Se debe actualizar el contexto con la línea de código de Scaffold-DbContext:

Realizar los cambios pertinentes con relación al **Server** y también **Database**.

De esta forma ya se logra generar el contexto de la base de datos como **PracticaSsmContext**.

```
Scaffold-DbContext "Server=CARLOS-AR;Database=practicaSSM;Trusted_Connection=True; Trust Server Certificate=true;" Microsoft.EntityFrameworkCore.SqlServer -OutputDir Models -Force
```

## 6. Configurar el archivo de Program.cs:

Se debe agregar la siguiente línea, lo cual permitirá que se pueda utilizar el contexto de la base de datos a nivel de proyecto:

Contexto: **PracticaSsmContext**.

Debe estar abajo de esta línea de código: **builder.Services.AddControllersWithViews();**.

```
builder.Services.AddDbContext<PracticaSsmContext>(o =>
{
    o.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConecction"));
});
```

## 7. Crear una consulta SELECT en la base de datos, con los campos que se desean mostrar:

````
SELECT v.fecha AS fecha_venta, p.nombre AS nombre_producto, dv.cantidad, dv.subtotal AS total FROM detalles_ventas dv INNER JOIN ventas v ON dv.venta_id = v.id INNER JOIN productos p ON dv.producto_id = p.id;
````

La consulta devuelve lo siguiente:

<img width="714" height="448" alt="image" src="https://github.com/user-attachments/assets/f5d1b57d-b889-4400-9cf9-6073d0794647" />

Esta consulta, puede ser distinta, todo depende de lo que se desee mostrar, así mismo radica mucho en los campos de las tablas.

<img width="738" height="776" alt="image" src="https://github.com/user-attachments/assets/a6a26e4f-a827-4ebb-b510-7f73df7d117b" />


## 8. Crear un método en el contexto PracticaSsmContext:

```
public virtual DbSet<DetalleVentasPdf> VentasPdf { get; set; }
```

### 8.1. Importar el método en OnModelCreating, siempre dentro del contexto PracticaSsmContext:

Los campos de esta "tabla" que se va a generar, deben ser exactamente iguales a los de la consulta SQL que se creó en el **paso 7**.

````
modelBuilder.Entity<DetalleVentasPdf>(entity =>
{
    entity.HasNoKey();

    entity.Property(e => e.FechaVenta)
        .HasColumnType("date")
        .HasColumnName("fecha_venta");

    entity.Property(e => e.NombreProducto)
        .HasMaxLength(100)
        .HasColumnName("nombre_producto");

    entity.Property(e => e.Cantidad)
        .HasColumnType("int")
        .HasColumnName("cantidad");

    entity.Property(e => e.Total)
        .HasColumnType("decimal(10,2)")
        .HasColumnName("total");
});
````

### 8.2. Realizar la importación en el contexto de la carpeta que se va a crear:

````
using practicasumativasintesis.Pdf;
````

# VISTA GENERAL DEL CONTEXTO: (la importación debe estar en la parte superior)

<img width="745" height="661" alt="image" src="https://github.com/user-attachments/assets/d9ba14b3-0cca-48d1-bd76-e858eef6947a" />

## 9. Crear la carpeta Pdf a nivel de proyecto:

<img width="432" height="220" alt="image" src="https://github.com/user-attachments/assets/b5ce7e00-5de0-4c41-a94f-8815f75fad67" />

## 10. Crear un clase llamada DetalleVentasPdf.cs en la carpeta Pdf:

<img width="234" height="48" alt="image" src="https://github.com/user-attachments/assets/938033ce-64ba-4896-8f32-0969709d464c" />

Los campos deben ser los mismos con relación la "tabla" que se agregó en **OnModelCreating** dentro del contexto **PracticaSsmContext**.

Debe tener la siguiente estructura:

````
namespace practicasumativasintesis.Pdf
{
    public class DetalleVentasPdf
    {
        public DateTime FechaVenta { get; set; }
        public string? NombreProducto { get; set; }
        public int Cantidad { get; set; }
        public decimal Total { get; set; }
    }
}
````

## 11. Crear la clase llamada DetalleVentasPdfDoc.cs en la carpeta Pdf: (EL NOMBRE PUEDE SER OTRO)

<img width="332" height="78" alt="image" src="https://github.com/user-attachments/assets/316f17f2-3ca2-4aae-ac96-1dfc437d7277" />

Realizar los cambios pertinentes en la clase, por ejemplo:

- Cambiar el método **private List<DEBE_CONTENER_EL_MÉTODO_CREADO_EN_EL_CONTEXTO> Model { get; }**.
- Así mismo en el método **public DetalleVentasPdfDoc(List<DEBE_CONTENER_EL_MÉTODO_CREADO_EN_EL_CONTEXTO> model)**.
- Los campos de la tabla que construye el PDF, deben ser exactamente iguales a los campos de la clase **DetalleVentasPdf.cs**
- Es esencial que el campo Total se convierta a **.ToString("C")**, ya que esto indica que será una cadena y no un entero.
- Verificar el nombre del proyecto en la línea **namespace practicasumativasintesis.Pdf**

Estructura de la clase:

````
using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;

namespace practicasumativasintesis.Pdf
{
    public class DetalleVentasPdfDoc : IDocument
    {
        private List<DetalleVentasPdf> Model { get; }
        public DetalleVentasPdfDoc(List<DetalleVentasPdf> model)
        {
            Model = model;
        }
        public void Compose(IDocumentContainer container)
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4);
                page.Margin(2, Unit.Centimetre);
                page.PageColor(Colors.White);
                page.DefaultTextStyle(x => x.FontSize(20));

                page.Header()
                    .Text("Volumen de ventas")
                    .SemiBold().FontSize(36).FontColor(Colors.Blue.Medium);

                page.Content()
                    .Column(column =>
                    {
                        column.Spacing(20);

                        column.Item().Text("Volumen de ventas");

                        // Table
                        column.Item().Table(table =>
                        {
                            table.ColumnsDefinition(columns =>
                            {
                                columns.RelativeColumn(2); // FECHA
                                columns.RelativeColumn(2); // PRODUCTO
                                columns.RelativeColumn(2); // CANTIDAD
                                columns.RelativeColumn(2); // TOTAL
                            });

                            // Header
                            table.Header(header =>
                            {
                                header.Cell().Element(CellStyle).Text("FechaVenta");
                                header.Cell().Element(CellStyle).Text("Producto");
                                header.Cell().Element(CellStyle).Text("Cantidad");
                                header.Cell().Element(CellStyle).Text("TOTAL");

                                static IContainer CellStyle(IContainer container) =>
                                    container.DefaultTextStyle(x => x.SemiBold()).PaddingVertical(5).BorderBottom(1).BorderColor(Colors.Grey.Medium);
                            });

                            // Rows
                            foreach (var item in Model)
                            {

                                table.Cell().Element(CellStyle).Text(item.FechaVenta.ToString("yyyy-MM-dd"));
                                table.Cell().Element(CellStyle).Text(item.NombreProducto);
                                table.Cell().Element(CellStyle).Text(item.Cantidad.ToString());
                                table.Cell().Element(CellStyle).Text(item.Total.ToString("C"));

                                static IContainer CellStyle(IContainer container) =>
                                    container.PaddingVertical(5);
                            }
                        });
                        page.Footer()
                            .AlignCenter()
                            .Text(x =>
                            {
                                x.Span("Página ");
                                x.CurrentPageNumber();
                            });
                    });
            });
        }
    }
}
````

## 12. Crear un controlador en la carpeta Controllers, puede ser uno vacío o construido con el asistente de EntityFramework:

En este caso, he configurado uno vacío llamado ProductoController, (PUEDE CONTENER OTRO NOMBRE).

<img width="287" height="79" alt="image" src="https://github.com/user-attachments/assets/3fa79415-b732-42f4-9bd4-88c9abc1de2c" />

Se debe hacer la agregación del contexto de la base de datos (**PracticaSsmContext**) y definir una función que contenga el contexto.

Código del controlador:

````
using Microsoft.AspNetCore.Mvc;
using practicasumativasintesis.Models;

namespace practicasumativasintesis.Controllers
{
    public class ProductoController : Controller
    {
        private readonly PracticaSsmContext _context;

        public ProductoController(PracticaSsmContext context)
        {
            _context = context;
        }
        public IActionResult Index()
        {
            return View();
        }
    }
}
````

### 12.1. Agregar la importaciones siguientes en el controlador:

````
using Microsoft.EntityFrameworkCore;
using practicasumativasintesis.Pdf;
using QuestPDF.Fluent;
````

## 13. Crear una función HttpGet para generar el PDF de los detalles de ventas:

Aquí se crea una variable **sql** para almacenar asignar la consulta hacia la base de datos:

Consulta:

````
SELECT v.fecha AS fecha_venta, p.nombre AS nombre_producto, dv.cantidad, dv.subtotal AS total FROM detalles_ventas dv INNER JOIN ventas v ON dv.venta_id = v.id INNER JOIN productos p ON dv.producto_id = p.id;
````

Función creada en el controlador y asignación en la variable **sql**.

- El nombre de HttpGet, debe ser el mismo de la clase que se creó y que contiene los campos/atributos de la "tabla" que se va a generar.
- En la línea: **var document** se debe agregar el nombre de la clase que construye al Pdf.
- En la línea donde se retorna (**return Results.File...**) justo donde dice "ventas.pdf", ese nombre es variante, puede ser otro (solo indica el nombre del documento PDF que se va a generar.

````
//Acción para generar el PDF de los detalles de ventas
[HttpGet(Name = "DetalleVentasPdf")]
public IResult DetalleVentasPdf(int n)
{
    string sql = "SELECT v.fecha AS fecha_venta, p.nombre AS nombre_producto, dv.cantidad, dv.subtotal AS total FROM detalles_ventas dv INNER JOIN ventas v ON dv.venta_id = v.id INNER JOIN productos p ON dv.producto_id = p.id;";
    List<DetalleVentasPdf> data = _context.VentasPdf
        .FromSqlRaw(sql)
        .ToList();
    var document = new DetalleVentasPdfDoc(data);
    var pdfStream = document.GeneratePdf();
    return Results.File(pdfStream, "application/pdf", "ventas.pdf");
}
````

## 14. Crear un botón para generar el PDF.

En este caso, el botón lo agregué en la vista **Index.cs** de la carpeta **Home**, puede ser otra ubicación dependiendo de las vistas que se contengan.

Código que crea el botón:

````
<a asp-controller="Producto" asp-action="DetalleVentasPdf" asp-route-n="3" class="btn btn-success mb-4">
    <i class="bi bi-file-earmark-pdf me-1"></i> Generar Reporte PDF
</a>
````

# ¡Listo!, ya se tiene un generador de PDF con datos dinámicos (traídos desde base de datos).

# Anexos:

_1. Vista del botón:_

<img width="1919" height="1079" alt="image" src="https://github.com/user-attachments/assets/d20d9746-6d7d-484f-bac8-5505436fa610" />

_2. Pdf generado:_

<img width="1919" height="1079" alt="image" src="https://github.com/user-attachments/assets/736edbb5-6fcd-47fc-bf1d-dd9337a6df95" />

